<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Zombie Death Run v.11.4 | Multiplayer</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
    <style>
        :root { --gold: #ffcc00; --zombie: #4ade80; }
        body { margin: 0; overflow: hidden; background: #000; font-family: 'Segoe UI', sans-serif; }
        #ui { position: absolute; width: 100%; height: 100%; pointer-events: none; z-index: 100; color: white; }
        .window { pointer-events: auto; background: rgba(0,0,0,0.9); border: 3px solid var(--gold); padding: 30px; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center; border-radius: 15px; min-width: 400px; }
        .server-item { background: #222; margin: 10px; padding: 15px; display: flex; justify-content: space-between; cursor: pointer; border-radius: 8px; border: 1px solid #444; }
        .hud { position: absolute; top: 20px; left: 20px; font-size: 24px; font-weight: bold; text-shadow: 2px 2px #000; }
        .plus-btn { font-size: 50px; color: var(--gold); cursor: pointer; }
        .hidden { display: none !important; }
    </style>
</head>
<body>

<div id="ui">
    <div id="browser-win" class="window">
        <h1 style="color: var(--gold);">SERVER BROWSER</h1>
        <div id="server-list">
            <div class="server-item" onclick="joinRoom('Global-Lobby')"><span>Global Lobby</span> <span>SYNCING...</span></div>
        </div>
        <div class="plus-btn" onclick="createNewServer()">+</div>
    </div>

    <div id="hud" class="hud hidden">
        COINS: <span id="coin-val">0</span> | <span id="role-name">RUNNER</span>
    </div>
</div>

<script>
/** 1. DATA & SYNC **/
let socket;
let account = JSON.parse(localStorage.getItem('zrun_v11') || '{"coins":0,"isZombie":false}');
let otherPlayers = {};

// REPLACE THIS WITH YOUR RENDER URL AFTER DEPLOYING server.js
const RENDER_URL = "https://your-app-name.onrender.com"; 

function connect(roomId) {
    socket = io(RENDER_URL);
    socket.emit('join_room', roomId);

    socket.on('update_players', (data) => {
        if (!otherPlayers[data.id]) createGhost(data.id, data.isZombie);
        otherPlayers[data.id].position.set(data.x, 4.2, data.z);
    });

    socket.on('remove_player', (id) => {
        if(otherPlayers[id]) { scene.remove(otherPlayers[id]); delete otherPlayers[id]; }
    });
}

/** 2. THREE.JS GAME **/
let scene, camera, renderer, player;
let isPlaying = false, velocityY = 0, isGrounded = true, gameObjects = [];

function init() {
    scene = new THREE.Scene();
    scene.background = new THREE.Color(0x87ceeb);
    camera = new THREE.PerspectiveCamera(75, window.innerWidth/window.innerHeight, 0.1, 1000);
    renderer = new THREE.WebGLRenderer({ antialias: true });
    renderer.setSize(window.innerWidth, window.innerHeight);
    document.body.appendChild(renderer.domElement);

    const sun = new THREE.DirectionalLight(0xffffff, 1.2);
    sun.position.set(0, 50, -50);
    scene.add(sun);
    scene.add(new THREE.AmbientLight(0x404040));

    createPlayerModel();
    generateLevel();
    animate();
}

function createPlayerModel() {
    if(player) scene.remove(player);
    player = new THREE.Group();
    const skin = account.isZombie ? 0x4ade80 : 0xffdbac;
    const body = new THREE.Mesh(new THREE.BoxGeometry(1, 1.5, 0.6), new THREE.MeshStandardMaterial({color: account.isZombie ? 0x2d5a27 : 0x00ff00}));
    const head = new THREE.Mesh(new THREE.CylinderGeometry(0.35, 0.35, 0.7), new THREE.MeshStandardMaterial({color: skin}));
    head.position.y = 1.1;
    player.add(body); player.add(head);

    if(account.isZombie) { // Zombie Pose
        const arm = new THREE.Mesh(new THREE.BoxGeometry(0.3, 1, 0.3), new THREE.MeshStandardMaterial({color: 0x2d5a27}));
        arm.position.set(0.7, 0.5, -0.5); arm.rotation.x = -Math.PI/2;
        player.add(arm);
    }

    player.position.set(0, 4.2, 0);
    scene.add(player);
}

function generateLevel() {
    for(let i=0; i<100; i++) {
        const b = new THREE.Mesh(new THREE.BoxGeometry(4, 0.5, 8), new THREE.MeshStandardMaterial({color: 0x333333}));
        b.position.set(0, 3, -i * 10);
        scene.add(b);
        gameObjects.push(b);
    }
}

function createGhost(id, zombieStatus) {
    const mesh = new THREE.Mesh(new THREE.BoxGeometry(1, 2, 1), new THREE.MeshStandardMaterial({color: zombieStatus ? 0x4ade80 : 0xffffff}));
    scene.add(mesh);
    otherPlayers[id] = mesh;
}

function joinRoom(id) {
    document.getElementById('browser-win').classList.add('hidden');
    document.getElementById('hud').classList.remove('hidden');
    connect(id);
    isPlaying = true;
}

function animate() {
    requestAnimationFrame(animate);
    if(isPlaying) {
        player.position.z -= 0.15;
        if(socket) socket.emit('move', { x: player.position.x, z: player.position.z, isZombie: account.isZombie });
        
        camera.position.set(player.position.x, player.position.y + 5, player.position.z + 12);
        camera.lookAt(player.position);
    }
    renderer.render(scene, camera);
}

init();
</script>
</body>
</html>